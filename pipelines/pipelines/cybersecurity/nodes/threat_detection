"""Nodes for threat detection and analysis."""
from typing import Dict, Tuple
import pandas as pd
import numpy as np

def detect_anomalies(
    logs: pd.DataFrame,
    threshold: float,
    window_size: int,
) -> Tuple[pd.DataFrame, pd.DataFrame]:
  
    connection_counts = logs.groupby("source_ip").size()
    
    anomalous_ips = connection_counts[connection_counts > threshold].index
    
    normal_logs = logs[~logs["source_ip"].isin(anomalous_ips)]
    anomalous_logs = logs[logs["source_ip"].isin(anomalous_ips)].copy()
    
    return normal_logs, anomalous_logs

def classify_threats(
    anomalous_logs: pd.DataFrame,
    threat_patterns: Dict[str, str],
) -> pd.DataFrame:
   
    classified = anomalous_logs.copy()
    classified["threat_category"] = "unknown"

    for pattern, threat_type in threat_patterns.items():
        mask = classified["event_type"].str.contains(pattern, case=False, na=False)
        classified.loc[mask, "threat_category"] = threat_type
    
    return classified

def calculate_risk_scores(
    threats: pd.DataFrame,
    severity_weights: Dict[str, float],
) -> pd.DataFrame:
  
    scored = threats.copy()
    
    severity_map = {
        "low": 1.0,
        "medium": 2.0,
        "high": 3.0,
        "critical": 4.0,
    }
    
    scored["severity_score"] = scored["severity"].map(severity_map)
    scored["risk_score"] = (
        scored["severity_score"] * severity_weights.get("severity_multiplier", 1.0)
    )
    
    return scored
